<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind Source Agent</title>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #webchat { height: 100%; width: 100%; }
  </style>
</head>

<body>
  <div id="webchat"></div>

    <script>
      const tokenEndpoint =
        "https://app-msagent-recomendation-site-hvdvb3brgwd4f5fk.westeurope-01.azurewebsites.net/api/get_directline_token";

      const directLineDomain = "https://europe.directline.botframework.com/v3/directline";

      function createCustomStore() {
        return window.WebChat.createStore(
          {},
          ({ dispatch }) => (next) => (action) => {
            if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
              dispatch({
                type: "DIRECT_LINE/POST_ACTIVITY",
                meta: { method: "keyboard" },
                payload: {
                  activity: {
                    type: "event",
                    name: "startConversation",
                    channelData: { postBack: true }
                  }
                }
              });
            }
            return next(action);
          }
        );
		 
		
      }

function forceSameTabLinks() {
  const webchatEl = document.getElementById("webchat");
  if (!webchatEl) return;

  function scrollToIdWithWixResetProtection(id) {
    const doc = window.top.document;

    const start = Date.now();
    const timeoutMs = 8000;     // espera até 8s pelo elemento
    const intervalMs = 120;     // frequência de tentativas
    const settleMs = 1800;      // janela extra para “vencer” o scroll reset do Wix

    let firstScrolledAt = null;

    const attemptScroll = () => {
      const el = doc.getElementById(id);

      // Ainda não existe: continua a tentar
      if (!el) {
        if (Date.now() - start < timeoutMs) setTimeout(attemptScroll, intervalMs);
        return;
      }

      // Existe: faz scroll
      el.scrollIntoView({ behavior: "smooth", block: "start" });

      // Marca o primeiro scroll
      if (!firstScrolledAt) firstScrolledAt = Date.now();

      // O Wix pode voltar a colocar no topo depois disto.
      // Reforça o scroll durante um curto período.
      const elapsedSinceFirst = Date.now() - firstScrolledAt;
      if (elapsedSinceFirst < settleMs) {
        setTimeout(() => {
          // Se o elemento ainda não estiver perto do topo, volta a forçar
          const rect = el.getBoundingClientRect();
          if (Math.abs(rect.top) > 40) {
            el.scrollIntoView({ behavior: "auto", block: "start" });		
          }
          attemptScroll();
        }, 250);
      }
    };

    attemptScroll();
  }

  // Em Wix "HTML incorporado", o conteúdo corre num iframe sandbox.
  // Não podemos navegar o topo diretamente (window.top.*).
  // Enviamos a navegação para a página Wix via postMessage.
  function requestNavigate(href) {
    window.parent.postMessage(
      { type: "NAVIGATE", href }, // ex: "/ms/sobre-nós#comp-mkvenu37"
      "*" // depois podes restringir para "https://jl0.wixsite.com"
    );
  }

  webchatEl.addEventListener(
    "click",
    function (event) {
      const a = event.target.closest("a");
      if (!a) return;

      const hrefRaw = a.getAttribute("href");
      if (!hrefRaw) return;

      event.preventDefault();
      event.stopPropagation();

      // Normaliza o link (aceita "#comp-...", "/ms/pagina#comp-...", e links absolutos)
      let target;
      try {
        target = new URL(hrefRaw, window.location.href);
      } catch {
        return;
      }

      // Se for só âncora, mantém a página atual e envia o hash
      if (hrefRaw.startsWith("#")) {
        const href = window.location.pathname + window.location.search + hrefRaw;
        requestNavigate(href);
        return;
      }

      // Envia pathname + search + hash para o Wix navegar na mesma aba
      requestNavigate(target.pathname + target.search + target.hash);
    },
    true
  );



async function init() {
        const res = await fetch(tokenEndpoint, { method: "POST" });
        const { token } = await res.json();
		 

        const directLine = window.WebChat.createDirectLine({
          domain: directLineDomain,
          token
        });
									
		  
										  
		

        window.WebChat.renderWebChat(
          {
            directLine,
            locale: "pt-PT",
            store: createCustomStore()
          },
          document.getElementById("webchat")
        );

        forceSameTabLinks();
      }
	   
	   

      init();
    </script>
  </body>
</html>


