<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind Source Agent 0007</title>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #webchat { height: 100%; width: 100%; }
  </style>
</head>

<body>
  <div id="webchat"></div>

  <script>
    const tokenEndpoint =
        "https://app-msagent-recomendation-site-hvdvb3brgwd4f5fk.westeurope-01.azurewebsites.net/api/get_directline_token";

      const directLineDomain = "https://europe.directline.botframework.com/v3/directline";

       function createCustomStore() {
      return window.WebChat.createStore(
        {},
        ({ dispatch }) => (next) => (action) => {
          if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
            dispatch({
              type: "DIRECT_LINE/POST_ACTIVITY",
              meta: { method: "keyboard" },
              payload: {
                activity: {
                  type: "event",
                  name: "startConversation",
                  channelData: { postBack: true }
                }
              }
            });
          }
          return next(action);
        }
      );
    }

    function forceSameTabLinks() {
      const webchatEl = document.getElementById("webchat");
      if (!webchatEl) return;

      function requestNavigate(href) {
        window.parent.postMessage(
          { type: "NAVIGATE", href },  // ex: "/ms/sobre-nós#comp-mkvenu37"
          "*"
        );
      }

      webchatEl.addEventListener("click", function (event) {
        const a = event.target.closest("a");
        if (!a) return;

        const hrefRaw = a.getAttribute("href");
        if (!hrefRaw) return;

        event.preventDefault();
        event.stopPropagation();

        // Caso: só hash (#comp-...)
        if (hrefRaw.startsWith("#")) {
          const href = window.location.pathname + window.location.search + hrefRaw;
          requestNavigate(href);
          return;
        }

        // Normaliza links relativos e absolutos
        let target;
        try {
          target = new URL(hrefRaw, window.location.href);
        } catch {
          return;
        }

        requestNavigate(target.pathname + target.search + target.hash);
      }, true);
    }

    async function init() {
      try {
        const res = await fetch(tokenEndpoint, { method: "POST" });
        if (!res.ok) throw new Error("Token endpoint HTTP " + res.status);

        const data = await res.json();
        if (!data.token) throw new Error("Resposta sem token: " + JSON.stringify(data));

        const directLine = window.WebChat.createDirectLine({
          domain: directLineDomain,
          token: data.token
        });

        window.WebChat.renderWebChat(
          {
            directLine,
            locale: "pt-PT",
            store: createCustomStore(),
            styleOptions: { linkTarget: "_self" }
          },
          document.getElementById("webchat")
        );

        forceSameTabLinks();
      } catch (e) {
        console.error(e);
        document.getElementById("webchat").innerHTML =
          "<div style='padding:12px;font-family:Arial'>❌ Erro a iniciar o chat. Ver consola (F12).</div>";
      }
    }

    init();
  </script>
</body>
</html>

