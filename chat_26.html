<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind Source Agent</title>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #webchat { height: 100%; width: 100%; }
  </style>
</head>

<body>
  <div id="webchat"></div>

    <script>
      const tokenEndpoint =
        "https://app-msagent-recomendation-site-hvdvb3brgwd4f5fk.westeurope-01.azurewebsites.net/api/get_directline_token";

      const directLineDomain = "https://europe.directline.botframework.com/v3/directline";

      function createCustomStore() {
        return window.WebChat.createStore(
          {},
          ({ dispatch }) => (next) => (action) => {
            if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
              dispatch({
                type: "DIRECT_LINE/POST_ACTIVITY",
                meta: { method: "keyboard" },
                payload: {
                  activity: {
                    type: "event",
                    name: "startConversation",
                    channelData: { postBack: true }
                  }
                }
              });
            }
            return next(action);
          }
        );
		 
		
      }

function forceSameTabLinks() {
  const webchatEl = document.getElementById("webchat");
  if (!webchatEl) return;

  function scrollToIdWithWixResetProtection(id) {
    const doc = window.top.document;

    const start = Date.now();
    const timeoutMs = 8000;     // espera até 8s pelo elemento
    const intervalMs = 120;     // frequência de tentativas
    const settleMs = 1800;      // janela extra para “vencer” o scroll reset do Wix

    let firstScrolledAt = null;

    const attemptScroll = () => {
      const el = doc.getElementById(id);

      // Ainda não existe: continua a tentar
      if (!el) {
        if (Date.now() - start < timeoutMs) setTimeout(attemptScroll, intervalMs);
        return;
      }

      // Existe: faz scroll
      el.scrollIntoView({ behavior: "smooth", block: "start" });

      // Marca o primeiro scroll
      if (!firstScrolledAt) firstScrolledAt = Date.now();

      // O Wix pode voltar a colocar no topo depois disto.
      // Reforça o scroll durante um curto período.
      const elapsedSinceFirst = Date.now() - firstScrolledAt;
      if (elapsedSinceFirst < settleMs) {
        setTimeout(() => {
          // Se o elemento ainda não estiver perto do topo, volta a forçar
          const rect = el.getBoundingClientRect();
          if (Math.abs(rect.top) > 40) {
            el.scrollIntoView({ behavior: "auto", block: "start" });		
          }
          attemptScroll();
        }, 250);
      }
    };

    attemptScroll();
  }

  function goSpa(urlObj) {
    // navegação SPA sem refresh
    window.top.history.pushState({}, "", urlObj.pathname + urlObj.search + urlObj.hash);
    window.top.dispatchEvent(new PopStateEvent("popstate"));
  }
  webchatEl.addEventListener(
  "click",
  function (event) {
    const a = event.target.closest("a");
    if (!a) return;

    const hrefRaw = a.getAttribute("href");
    if (!hrefRaw) return;

    event.preventDefault();
    event.stopPropagation();

    let target;
    try {
      target = new URL(hrefRaw, window.location.href);
    } catch {
      return;
    }

    // Envia para a página Wix a navegação pretendida
    window.parent.postMessage(
      {
        type: "NAVIGATE",
        href: target.pathname + target.search + target.hash
      },
      "*" // podes restringir depois ao domínio wix
    );
  },
  true
);


async function init() {
        const res = await fetch(tokenEndpoint, { method: "POST" });
        const { token } = await res.json();
		 

        const directLine = window.WebChat.createDirectLine({
          domain: directLineDomain,
          token
        });
									
		  
										  
		

        window.WebChat.renderWebChat(
          {
            directLine,
            locale: "pt-PT",
            store: createCustomStore()
          },
          document.getElementById("webchat")
        );

        forceSameTabLinks();
      }
	   
	   

      init();
    </script>
  </body>
</html>

