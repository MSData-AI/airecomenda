<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind Source Agent</title>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #webchat { height: 100%; width: 100%; }
    #status {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      color: #222;
      padding: 16px;
      text-align: center;
      z-index: 99999;
    }
    #status.hidden { display: none; }
    #status pre { white-space: pre-wrap; max-width: 900px; }
  </style>
</head>

<body>
  <div id="status"><div>
  <div style="font-weight:700;margin-bottom:8px;">A iniciar o chat…</div>
  <div style="opacity:.7">Se isto ficar aqui, abre F12 → Console.</div>
  </div></div>

  <div id="webchat"></div>

  <script>
      const tokenEndpoint = "https://app-msagent-recomendation-site-hvdvb3brgwd4f5fk.westeurope-01.azurewebsites.net/api/get_directline_token";

      const directLineDomain = "https://europe.directline.botframework.com/v3/directline";

    function showError(err) {
      console.error(err);
      const status = document.getElementById("status");
      status.classList.remove("hidden");
      status.innerHTML = `
        <div>
          <div style="font-weight:700;margin-bottom:8px;">❌ Erro a iniciar o chat</div>
          <pre>${String(err && err.stack ? err.stack : err)}</pre>
          <div style="opacity:.7;margin-top:10px;">Abre F12 → Network e vê a chamada ao token endpoint.</div>
        </div>`;
    }

    function hideStatus() {
      document.getElementById("status").classList.add("hidden");
    }
    function createCustomStore() {
      return window.WebChat.createStore(
        {},
        ({ dispatch }) => (next) => (action) => {
          if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
            dispatch({
              type: "DIRECT_LINE/POST_ACTIVITY",
              meta: { method: "keyboard" },
              payload: {
                activity: {
                  type: "event",
                  name: "startConversation",
                  channelData: { postBack: true }
                }
              }
            });
          }
          return next(action);
        }
      );
    }

    function forceSameTabLinks() {
      const webchatEl = document.getElementById("webchat");
      if (!webchatEl) return;

      function scrollToIdWithWixResetProtection(id) {
        const doc = window.top.document;

        const start = Date.now();
        const timeoutMs = 8000;
        const intervalMs = 120;
        const settleMs = 1800;

        let firstScrolledAt = null;

        const attempt = () => {
          const el = doc.getElementById(id);

          if (!el) {
            if (Date.now() - start < timeoutMs) setTimeout(attempt, intervalMs);
            return;
          }

          el.scrollIntoView({ behavior: "smooth", block: "start" });

          if (!firstScrolledAt) firstScrolledAt = Date.now();

          const elapsed = Date.now() - firstScrolledAt;
          if (elapsed < settleMs) {
            setTimeout(() => {
              const rect = el.getBoundingClientRect();
              if (Math.abs(rect.top) > 40) {
                el.scrollIntoView({ behavior: "auto", block: "start" });
              }
              attempt();
            }, 250);
          }
        };

        attempt();
      }

      webchatEl.addEventListener("click", (event) => {
        const a = event.target.closest("a");
        if (!a) return;

        const hrefRaw = a.getAttribute("href");
        if (!hrefRaw) return;

        event.preventDefault();
        event.stopPropagation();

        // Só hash
        if (hrefRaw.startsWith("#")) {
          window.top.history.replaceState(
            {},
            "",
            window.top.location.pathname + window.top.location.search + hrefRaw
          );
          scrollToIdWithWixResetProtection(hrefRaw.slice(1));
          return;
        }

        let target;
        try {
          target = new URL(hrefRaw, window.top.location.href);
        } catch {
          return;
        }

        const current = new URL(window.top.location.href);
        const samePath = target.pathname === current.pathname;
        const sameSearch = target.search === current.search;

        // Mesma página + hash
        if (samePath && sameSearch && target.hash) {
          window.top.history.replaceState({}, "", target.pathname + target.search + target.hash);
          scrollToIdWithWixResetProtection(target.hash.slice(1));
          return;
        }

        // Outra página SPA (sem refresh)
        window.top.history.pushState({}, "", target.pathname + target.search + target.hash);
        window.top.dispatchEvent(new PopStateEvent("popstate"));

        if (target.hash) {
          scrollToIdWithWixResetProtection(target.hash.slice(1));
        }
      }, true);
    }

    async function init() {
      const res = await fetch(tokenEndpoint, { method: "POST" });
       if (!res.ok) throw new Error("Token endpoint HTTP " + res.status + " " + await res.text());

        const data = await res.json();
        if (!data.token) throw new Error("Resposta sem token: " + JSON.stringify(data));

      const directLine = window.WebChat.createDirectLine({
        domain: directLineDomain,
        token
      });

      window.WebChat.renderWebChat(
        {
          directLine,
          locale: "pt-PT",
          styleOptions: { linkTarget: "_self" }
        },
        document.getElementById("webchat")
      );

      forceSameTabLinks();
    }

        hideStatus();
      } catch (e) {
        showError(e);
      }
    }
    
    init();
  </script>
</body>
</html>


